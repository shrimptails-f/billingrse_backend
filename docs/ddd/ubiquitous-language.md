# ユビキタス言語定義

- 以下は設計・実装・会話で共通に使う言葉
- 事実／判断／仮説が混ざらないように整理済み

## ユーザー（User）

### 定義
- サービスを利用する主体

### 説明
- 認証とデータ分離の単位

## ログイン（Login）

### 定義
- ユーザーとして操作できる状態になること

### 説明
- 認証に成功し、利用が許可された状態

## ログアウト（Logout）

### 定義
- 認証状態を終了し、ユーザーとして操作できない状態にすること

### 説明
- 利用中の認証状態を無効化する

## メールサービス（MailService）

### 定義
- Gmail / Outlook など、Email を提供するサービスの種別

### 説明
- API / IMAP などの接続方式を持つ

### ルール
- ユーザー単位ではなく、サービス種別の概念

## メールアカウント連携（MailAccountConnection）

### 定義
- ユーザーごとのメールサービス接続情報（認可情報を含む）

### 説明
- トークン / スコープ / 接続状態 / 外部アカウント識別子を持つ

### ルール
- 1つの連携は1つのメールサービスに紐づく
- ユーザーは複数の連携を持てる
- 連携が失効した場合はメール取得を停止する

## メール取得（MailFetch）

### 定義
- 手動・バッチのいずれかで Email を取得する行為の総称

### 説明
- 概念的な用語であり、実装上の実体は持たない

### ルール
- プログラム上のエンティティやテーブルにはしない
- 実装上は「手動メール取得」「メール取得バッチ」に分けて扱う

## 手動メール取得（ManualMailFetch）

### 定義
- 手動トリガーで即時実行される Email 取得

### 説明
- メールアカウント連携と取得条件に基づいて実行する

### ルール
- Email の意味解釈は持たない

## メール取得バッチ（MailFetchBatch）

### 定義
- 定期実行されるメール取得のための設定レコード

### 説明
- 取得条件（期間 / ラベル / 送信元など）と実行スケジュールを持つ

### ルール
- 認可情報は持たない（メールアカウント連携に委譲）
- 起動時刻になったレコードが対象
- 実行方式は将来拡張予定

## メール（Email）

### 定義
- メールサービスから取得した、加工前の一次情報

### 説明
- 件名・本文・送信元・受信日時などを含む
- 意味解釈を一切持たない

### ルール
- 「請求メール」という言葉は使わない
- すべての請求は、必ず参照元の Email を辿れる

## メール解析結果（ParsedEmail）

### 定義
- メールを AI に解析させて得られた、構造化された推定データ

### 説明
- 金額・日付・支払先名・支払いタイプなどを含む
- 推定結果であり、誤りを含む可能性がある

### ルール
- ParsedEmail 単体では「請求」とは呼ばない
- 請求かどうかの最終判断は持たない

## 支払先（Vendor）

### 定義
- 請求の支払い対象となる、正規化された事業者・サービス

### 例
- Netflix
- AWS
- Google

### ルール
- 表記揺れは Vendor に集約する
- Vendor は請求より長寿命の概念

## 請求（Billing）

### 定義（確定）
- 金額・日付・支払先が確定した、支払いの事実

### 必須属性
- 請求ID
- ユーザーID
- 支払先（Vendor）
- 金額
- 通貨
- 請求日
- 支払周期（単発 / 定期）
- 支払いタイプ
- 参照元（Email / ParsedEmail）

### ルール
- 請求は必ず Vendor を持つ
- 請求は必ず参照元を持つ
- 請求は「支払われたかどうか」を表さない

## 支払いタイプ（PaymentType）

### 定義
- 請求がどのような性質の支払いかを表す分類

### 説明
- 定期課金
- 単発課金
- 従量課金
- 返金
- 手数料 など

### 備考
- 会計的な意味付けは行わない

## 請求成立判定（BillingEligibility）

### 定義
- メール解析結果が、請求として成立可能かどうかを評価する基準

### 説明
- メール解析結果を入力に取る
- 業務ルールに基づいて成立可否を判断する
- 永続化されない判断モデル

### 確定文
- 請求は、メール解析結果が請求成立条件を満たした場合に生成される

## 用語間の関係（言語レベル）

```
ユーザー
  ↓ 連携
メールアカウント連携
  ↓
メール取得（手動メール取得/メール取得バッチ）
  ↓
メール
  ↓ 解析
メール解析結果
  ↓ 請求成立判定
請求
  └─ 支払先

メールサービス
  ↓ 連携
メールアカウント連携
  ↓
メール取得（手動メール取得/メール取得バッチ）
  ↓
メール
  ↓ 解析
メール解析結果
  ↓ 請求成立判定
請求
  └─ 支払先
```

## 意図的に未定義としている言葉

注記: 今は使わない（将来のサブドメイン）

- 支出
- 家計簿
- 会計
- 月次集計
- 合計金額
