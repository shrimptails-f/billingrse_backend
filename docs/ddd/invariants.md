# 不変条件（Invariants）

本ファイルはドメイン上の「必ず守るべきルール」を整理する。用語の定義は `docs/ddd/ubiquitous-language/README.md` を参照。

## 全体
- 請求の同一性は「ユーザー + Vendor + 請求番号」で判定する
- 請求は支払い済みかどうかを表さない

## ユーザー / 認証
- メールアドレスはユーザー間で一意
- パスワードは平文で保持しない
- EmailVerified が true の場合、EmailVerifiedAt は必須
- メール認証トークンは必ずユーザーに紐づく
- メール認証トークンは有効期限を持つ
- メール認証トークンは1回のみ消費できる

## メールサービス / 連携 / 取得
- メールアカウント連携は必ず1つのメールサービスに紐づく
- ユーザーは複数のメールアカウント連携を持てる
- メールアカウント連携はアクセストークン / リフレッシュトークンを必須で持つ
- 連携が失効した場合、メール取得は失敗し、エラー記録を行う
- メール取得は概念のみ（実装上の実体は持たない）
- 手動/バッチともに「期間 + ラベル」が必須の取得条件
- メール取得バッチは認可情報を持たず、メールアカウント連携に委譲する

## メール / 解析
- メールは「外部メッセージID + ユーザーID」で一意
- 1メールにつきメール解析結果は0件以上（複数件になり得る）
- メール解析結果は推定であり、最終判断は持たない

## 請求
- 請求成立の必須項目は「Vendor + 金額（通貨含む） + 請求日 + 支払周期 + 請求番号」
- 請求番号は必須（請求の同一性に使う）
- インボイス番号は任意（適格請求書発行事業者登録番号: "T" + 数字13桁）
- 参照元メールは1請求につき1件のみ
- 同一請求番号の請求は作成しない
