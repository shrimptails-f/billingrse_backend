# ADR 0003: 請求番号とインボイス番号の分離、支払周期の採用

Status: Accepted  
Date: 2026-01-30

## Context
請求番号（ベンダーが発行する番号）とインボイス制度における番号が混同されやすく、
InvoiceNumber の意味が曖昧だった。インボイス番号を持たない事業者も存在するため、
請求成立要件や識別子の扱いを見直す必要があった。また、支払いの性質よりも
単発/定期の区別が主要な要件となった。

加えて、DDDの文書・モデル・実装を突き合わせる中で、請求番号の必須/任意や
請求成立の必須項目が文書と実装でズレていることが判明した。請求の同一性判定や
重複防止、外部連携との突き合わせを安定させるには、識別子と必須項目の定義を
一度明確に揃える必要があった。

## 経緯
- 当初は InvoiceNumber を「請求番号」として扱っていたが、インボイス制度の文脈と衝突した。
- その後「請求番号は任意」として整理したが、ドキュメント/実装間で必須/任意が混在した。
- 請求の同一性判定・重複防止・外部連携の突き合わせを安定させるには、
  請求番号を必須にして一意性の基準を固定した方が運用しやすいと判断した。
- 「性質（PaymentType）」よりも「単発/定期（PaymentCycle）」の区別が要件として重要だった。
- 上記を踏まえ、請求番号とインボイス番号の定義を分離し、
  PaymentCycle を採用しつつ、必須項目の定義を拡張して統一する方針に整理した。

## Decision
- 請求番号（BillingNumber）を新設し、ベンダーが発行する請求書識別子として扱う。
  - BillingNumber は必須（空は不可）。
- InvoiceNumber は「適格請求書発行事業者登録番号（インボイス番号）」と定義する。
  - 形式は "T" + 数字13桁。
  - 任意（nil/空は許容）。
- 請求成立の必須項目は「Vendor + 金額（通貨含む） + 請求日 + 支払周期 + 請求番号」とする。
- 支払いの分類は PaymentType ではなく PaymentCycle（単発/定期）を採用する。
- ParsedEmail の推定項目は以下に整理する。
  - vendorName, billingNumber, invoiceNumber, amount, currency, billingDate, paymentCycle, extractedAt
  - amount は小数第3位までの数値を許容する。
- Money は float ではなく decimal を採用し、小数第3位までのスケールを保証する。
- 通貨コードは ISO 4217 の3文字コードを前提としつつ、当面は JPY / USD のみ許容する。

## Consequences
- ADR 0001/0002 にある「請求番号任意/支払いタイプ」等の記述は、本ADRにより上書きされる。
- 解析プロンプトや DTO で billingNumber / invoiceNumber / paymentCycle の取り扱いが必須になる。
- 既存データ/移行時には BillingNumber の補完方針（再解析・手動補正・一時ID付与など）が必要になる。
- InvoiceNumber の検証は "T" + 13桁に限定されるため、他形式は BillingNumber に格納する。
- Money の永続化・集計・比較は decimal 前提となるため、DB/DTO/集計処理の型整合が必要になる。
- 通貨は当面 JPY / USD に限定されるため、他通貨の追加時は ADR 更新と検証ロジック拡張が必要になる。
