# ADR 0001: DDDベースラインの意思決定（ユビキタス言語 / 不変条件 / 集約境界）

Status: Accepted  
Date: 2026-01-25

## Context
メールサービス連携によるメール取得・解析から請求生成までのドメインについて、
共通語彙と不変条件、初期の集約境界を揃える必要があった。

## Decision
- 利用主体は「ユーザー（User）」で統一し、ログイン/ログアウトをユーザーの手続きとして扱う
- 用語は以下で整理する
  - メールサービス（MailService）
  - メールアカウント連携（MailAccountConnection）
  - メール取得（MailFetch）※概念のみ
  - 手動メール取得（ManualMailFetch）
  - メール取得バッチ（MailFetchBatch）
  - バッチ設定（BatchSetting）
  - メール（Email）
  - メール解析結果（ParsedEmail）
  - 請求成立判定（BillingEligibility）
  - 請求（Billing）
  - 支払先（Vendor）
- メール取得（MailFetch）は概念であり、実装上の実体を持たない
- メール取得バッチ（MailFetchBatch）は独立集約とする
- バッチ設定（BatchSetting）は独立集約とし、ユーザーが所有する
- メールアカウント連携（MailAccountConnection）は独立集約とする
- メール取得（手動/バッチ）の取得条件は「期間 + ラベル」を必須とする
- メールの一意性は「外部メッセージID + ユーザーID」で判定する
- 1メールにつきメール解析結果は1件のみ
- 請求番号がないものは請求成立判定で弾く
- 請求の同一性は「ユーザー + Vendor + 請求番号」で判定する
- 同一請求番号の請求は作成しない
- 請求成立の必須項目は「請求番号 + Vendor + 金額」
- 請求は支払い済みかどうかを表さない
- 参照元メールは1請求につき1件のみ
- 連携失効時はメール取得を失敗扱いとし、エラー記録を行う

## Consequences
- 支払済みステータスや通知イベントは当面モデルに含めず、請求の一意性と参照元の整合性に集中する
- 請求番号が欠落するメールはドメイン上の請求対象にならない
- バッチ設定の変更はメールアカウント連携の更新と独立して行える
